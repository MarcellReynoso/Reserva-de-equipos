@model Reserva_de_equipos.Models.Reserva

@{
    var isEdit = Model != null && Model.ReservaId > 0;
    bool readOnly = (ViewBag.ReadOnly as bool?) == true;
}

<div class="modal fade" id="crearReservaModal" data-readonly="@(readOnly ? "true" : "false")" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header border-2 py-4 pb-1">
                <h3 class="h3" id="crearReservaModalLabel">Reserva de equipos</h3>
            </div>

            <div class="modal-body">

                <form 
                    asp-controller="Reservas" 
                    asp-action="@(isEdit ? "Edit" : "Create")"
                    asp-route-id = "@(isEdit ? Model.ReservaId : null)"
                    method="post" 
                    novalidate class="modal-form p-3"
                >
                    @Html.AntiForgeryToken()
                    @if (isEdit)
                    {
                        <input type="hidden" asp-for="ReservaId" />
                    }
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

                    <!-- Notificación campos obligatorios -->
                    <div class="row align-items-center g-2 mb-3">
                        <div class="col-auto">
                            <div class="alert alert-warning d-flex align-items-center py-2 px-3 mb-0" role="alert"
                                 style="border-left: 5px solid #795b25;">
                                <iconify-icon icon="material-symbols:info-outline" class="me-2" style="font-size: 1.3rem;"></iconify-icon>
                                <span class="text-justify">
                                    Todos los campos marcados con <strong>(*)</strong> son obligatorios.
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Tipo y equipo -->
                    <div class="row align-items-center g-2 mb-3">
                        <div class="col-6">
                            <div class="text-sm-start">
                                <label for="TipoEquipoId" class="col-form-label fw-semibold">Tipo de equipo (*)</label>
                            </div>
                            <div class="">
                                <select id="TipoEquipoId" name="TipoEquipoId" class="form-select" asp-items="ViewBag.TiposEquipo">
                                    <option value="" selected disabled>Seleccione un tipo</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-sm-start">
                                <label asp-for="EquipoId" class="col-form-label fw-semibold">Equipo (*)</label>
                            </div>
                            <div class="">
                                <select asp-for="EquipoId" class="form-select" id="EquipoId" asp-items="ViewBag.Equipos">
                                    <option value="" selected disabled>Seleccione un equipo</option>
                                </select>
                                <span asp-validation-for="EquipoId" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Ubicación -->
                    <div class="col-12 col-sm-4 text-sm-start">
                        <label asp-for="Ubicación" class="col-form-label fw-semibold">Ubicación (*)</label>
                    </div>

                    <div class="row align-items-center g-2 mb-3">
                        <div class="position-relative" id="UbicacionWrapper">
                            <div class="input-group">
                                <input asp-for="Ubicación" class="form-control" id="UbicacionInput"
                                       placeholder="Escribe una dirección o elige en el mapa" autocomplete="off" />
                                <button type="button"
                                        id="btnElegirMapa"
                                        class="btn btn-outline-primary"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#mapWrapper"
                                        aria-expanded="false"
                                        aria-controls="mapWrapper">
                                    Ver mapa
                                </button>
                                <!-- Dropdown de sugerencias -->
                                <div id="AutocompleteList"
                                     class="list-group position-absolute w-100 z-3"
                                     style="max-height: 260px; overflow-y: auto; display:none;">
                                </div>
                            </div>
                            <span asp-validation-for="Ubicación" class="text-danger small"></span>

                            <!-- Campos ocultos para coordenadas -->
                            <input type="hidden" asp-for="Latitud" id="Latitud" />
                            <input type="hidden" asp-for="Longitud" id="Longitud" />

                            <!-- Contenedor del mapa (colapsable) -->
                            <div id="mapWrapper" class="mt-2 collapse">
                                <div id="map" style="height: 350px; border-radius: 8px; overflow: hidden;"></div>
                                @* <div class="d-flex justify-content-between align-items-center text-muted mt-1">
                                    <span class="small text-bg-light-gray">Seleccione una ubicación en el mapa.</span>
                                    <button type="button" id="btnUsarPunto" class="btn btn-success">Hecho</button>
                                </div> *@
                            </div>
                        </div>
                    </div>

                    <!-- Fechas -->
                    <div class="row align-items-center g-2 mb-3">
                        <div class="col-6">
                            <div class="text-sm-start">
                                <label asp-for="FechaInicio" class="col-form-label fw-semibold">Fecha de inicio (*)</label>
                            </div>
                            <div class="">
                                <input asp-for="FechaInicio" type="datetime-local" class="form-control" />
                                <span asp-validation-for="FechaInicio" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-sm-start">
                                <label asp-for="FechaFin" class="col-form-label fw-semibold"></label>
                            </div>
                            <div class="">
                                <input asp-for="FechaFin" type="datetime-local" class="form-control" id="FechaFin" />
                                <span asp-validation-for="FechaFin" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>
                    <div class="row align-items-center g-2">
                        <div class="form-check mt-2">
                            <input asp-for="Indefinido" class="form-check-input" id="Indefinido" onclick="toggleFechaFin()" />
                            <label asp-for="Indefinido" class="form-check-label">Indefinido</label>
                        </div>

                        @* Script del comportamiento del mapa y del Fecha de fin desplegable *@
                        <script>
                            function toggleFechaFin() {
                              const check    = document.getElementById('Indefinido');
                              const fechaFin = document.getElementById('FechaFin');
                              const alertEl  = document.getElementById('alertFinWrapper');

                              // Instancia (o reutiliza) el collapse de Bootstrap sin togglear automáticamente
                              const collapse = bootstrap.Collapse.getOrCreateInstance(alertEl, { toggle: false });

                              if (check.checked) {
                                if (fechaFin) {
                                  fechaFin.value = '';
                                  fechaFin.disabled = true;
                                }
                                collapse.show();   // ← muestra la alerta
                              } else {
                                if (fechaFin) fechaFin.disabled = false;
                                collapse.hide();   // ← oculta la alerta
                              }
                            }
                            // Inicializa estado cuando el modal se abre (útil para "Editar")
                            document.addEventListener('shown.bs.modal', function (e) {
                              if (e.target.id !== 'crearReservaModal') return;
                              // Ejecuta después de pintar el DOM del modal
                              setTimeout(toggleFechaFin, 0);
                            });

                            // Por si el partial también se renderiza directamente en la página (no solo modal)
                            document.addEventListener('DOMContentLoaded', function () {
                              const modal = document.getElementById('crearReservaModal');
                              // Si el modal ya está en el DOM, podemos inicializar su estado
                              if (modal) setTimeout(toggleFechaFin, 0);
                            });
                        </script>
                    </div>

                    <!-- Notificación de la fecha de fin -->
                    <div class="row align-items-center g-2 mb-3">
                        <div class="col-12">
                            <div id="alertFinWrapper" class="collapse">
                                <div class="alert alert-info d-flex align-items-center py-2 px-3 mb-0"
                                     role="alert"
                                     style="border-left: 5px solid #0dcaf0; background-color: #e8f8fc;">
                                    <iconify-icon icon="material-symbols:info-outline" class="me-2" style="font-size: 1.3rem;"></iconify-icon>
                                    <span class="text-justify">
                                        <strong>Nota:</strong> Estimado usuario, su reserva no tendrá una <b>Fecha de Fin</b> establecida si marca la casilla <em>“Indefinido”</em>.
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="row g-2">
                            <label asp-for="Descripcion" class="col-form-label fw-semibold mb-0">Notas</label>
                            <textarea asp-for="Descripcion" class="form-control" rows="3" placeholder="Detalles de la reserva..."></textarea>
                            <span asp-validation-for="Descripcion" class="text-danger small"></span>
                    </div>

                    <div class="d-flex justify-content-end gap-2 pt-2">
                        <button type="submit" class="btn btn-primary px-4">Guardar</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
