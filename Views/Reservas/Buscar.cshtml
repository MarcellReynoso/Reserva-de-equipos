@{
    ViewData["Title"] = "ReQ GoSoft | Reserva ahora";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div>
    <!-- Barra de búsqueda -->
    <form id="frmBuscar" class="mb-3">
        <div class="row g-3 align-items-center">
            <div class="col-lg-3 col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-light gap-2">
                        <iconify-icon icon="flowbite:truck-solid"></iconify-icon>
                        Equipo
                    </span>
                    <select id="tipoId" class="form-select" autofocus>
                        <option disabled selected value="">Seleccionar </option>
                        @foreach (var tipo in (SelectList)ViewBag.TiposEquipo)
                        {
                            <option value="@tipo.Value">@tipo.Text</option>
                        }
                    </select>
                </div>
            </div>

            <div class="col-lg-4 col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-light gap-2">
                        <iconify-icon icon="fluent:calendar-ltr-48-filled"></iconify-icon>
                        Fecha de inicio
                    </span>
                    <input id="fechaInicio"
                           type="datetime-local"
                           class="form-control" />
                </div>
            </div>

            <div class="col-lg-4 col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-light gap-2">
                        <iconify-icon icon="fluent:calendar-rtl-16-filled"></iconify-icon>
                        Fecha de fin
                    </span>
                    <input id="fechaFinal"
                           type="datetime-local"
                           class="form-control" />
                </div>
            </div>

            <div class="col-lg-1 col-12">
                <button id="btnBuscar" class="btn btn-primary w-100" type="submit" title="Buscar">
                    Buscar
                </button>
            </div>
        </div>

        <!-- Ubicación -->
        <div class="row mt-3">
            <div class="col-lg-4 mt-3 mb-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white fw-semibold">
                        ¿A dónde desea reservar?
                    </div>
                    <div class="p-3 pt-0">
                        <div id="UbicacionWrapper">
                            <div class="input-group mb-2">
                                <input id="UbicacionInput" class="form-control"
                                       placeholder="Selecciona un punto en el mapa"
                                       autocomplete="off" readonly />
                            </div>

                            <input type="hidden" id="Latitud" />
                            <input type="hidden" id="Longitud" />

                            <!-- Mapa -->
                            <div id="mapWrapper" class="mt-2">
                                <div id="map" style="height: 300px; border-radius: .375rem;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resultados -->
            <div class="col-lg-8 mt-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-header mb-2">Equipos disponibles</h5>
                    <small id="countText" class="text-muted"></small>
                </div>
                <div id="cardsHost">
                    <!-- cards dinámicas -->
                </div>
            </div>
        </div>

    </form>
</div>

@section Scripts {

    @* 1. Script de mapa (sin autocompletado) *@
    <script>
        (() => {
          let map, marker;
          const UbicacionInput = document.getElementById('UbicacionInput');
          const Latitud        = document.getElementById('Latitud');
          const Longitud       = document.getElementById('Longitud');

          function ensureMap() {
            if (map) return;

            map = L.map('map').setView([-12.0464, -77.0428], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            marker = L.marker([-12.0464, -77.0428], { draggable: true }).addTo(map);

            if (navigator.geolocation) {
              UbicacionInput.placeholder = "Obteniendo ubicación…";
              navigator.geolocation.getCurrentPosition(
                async (pos) => {
                  const { latitude, longitude } = pos.coords;
                  map.setView([latitude, longitude], 15);
                  marker.setLatLng([latitude, longitude]);
                  setCoords(latitude, longitude);
                  UbicacionInput.value = await reverseGeocode(latitude, longitude);
                },
                () => {},
                { enableHighAccuracy: true, timeout: 10000 }
              );
            }

            marker.on('dragend', async () => {
              const { lat, lng } = marker.getLatLng();
              setCoords(lat, lng);
              UbicacionInput.value = await reverseGeocode(lat, lng);
            });

            map.on('click', async (e) => {
              marker.setLatLng(e.latlng);
              setCoords(e.latlng.lat, e.latlng.lng);
              UbicacionInput.value = await reverseGeocode(e.latlng.lat, e.latlng.lng);
            });
          }

          function setCoords(lat, lon){ Latitud.value = lat; Longitud.value = lon; }

          async function reverseGeocode(lat, lon){
            try {
              const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
              const j = await r.json();
              return j.display_name || `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            } catch(_) { return `${lat.toFixed(6)}, ${lon.toFixed(6)}`; }
          }

          document.addEventListener('DOMContentLoaded', () => {
            ensureMap();
            setTimeout(() => { if (map) map.invalidateSize(); }, 150);
          });

          // Exponer coords para otros scripts (sin redeclararlas)
          window._coordsRefs = { Latitud, Longitud };
        })();
    </script>

    @* 2. Lista de equipos *@
    <script>
        (() => {
          const cardsHost = document.getElementById('cardsHost');
          const countText = document.getElementById('countText');
          const tipoSel   = document.getElementById('tipoId');
          // Reusar referencias del primer script:
          const { Latitud, Longitud } = window._coordsRefs || {};

          function renderCards(items){
            countText.textContent = items.length ? `${items.length} encontrados` : '0 encontrados';

            if (!items.length){
              cardsHost.innerHTML = `<div class="alert alert-light border">No se encontraron equipos con los filtros indicados.</div>`;
              return;
            }

            cardsHost.innerHTML = items.map(it => `
              <div class="card shadow-sm">
                <div class="row g-0">
                  <div class="col-md-6">
                    <img src="${(it.imagenUrl || '/assets/images/placeholder.png')}"
                         class="img-fluid rounded-start" alt="${it.nombre}">
                  </div>
                  <div class="col-md-6">
                    <div class="card-body">
                      <h5 class="card-title fw-semibold mb-1" style="font-size: 24px;">${it.nombre}</h5>
                      <p class="card-text small mb-2 text-muted" style="font-size: 18px;">${it.tipo ?? ''}</p>
                      <p class="card-text small mb-2" style="font-size: 14px;">
                        <strong>Equipo disponible:</strong>
                        ${it.fechaInicio ? formatFecha(it.fechaInicio) : 'Sin fecha'} -
                        ${it.fechaFin ? formatFecha(it.fechaFin) : 'Sin fecha'}
                      </p>
                      ${it.descripcion ? '<div id="notificacionDetalle" class="row align-items-center g-2 mb-1">' +
                          '<div class="col-auto">' +
                              '<div class="alert alert-primary d-flex align-items-center py-2 mb-0" role="alert" ' +
                                   'style="border-left: 5px solid #00588c;">' +
                                  '<span style="font-size: 12px;">' +
                                      '<strong>Detalle: </strong> ' + (it.descripcion || '-') +
                                  '</span>' +
                              '</div>' +
                          '</div>' +
                      '</div>' : ''}
                      <div class="d-flex justify-content-between align-items-end">
                      <p class="card-text mb-1"><strong>Cantidad de reservas:</strong> ${it.nroReservas}</p>
                          <button type="button"
                                  class="btn btn-md btn-outline-primary mt-2 btn-ver-reservas"
                                  data-equipo-id="${it.equipoId}">
                            Ver reservas &gt;
                          </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `).join('');
          }

          function formatFecha(fechaStr) {
            if (!fechaStr) return '';
            const f = new Date(fechaStr);
            if (isNaN(f)) return '';
            return f.toLocaleDateString('es-PE', { year: 'numeric', month: 'short', day: 'numeric' });
          }

          // Click en “Ver reservas”: exige ubicación
          cardsHost.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-ver-reservas');
            if (!btn) return;

            const lat = Latitud?.value?.trim();
            const lon = Longitud?.value?.trim();

            if (!lat || !lon) {
              alert('Selecciona una ubicación en el mapa antes de ver las reservas del equipo.');
              return;
            }

            const equipoId = btn.dataset.equipoId;
            const ubi = document.getElementById('UbicacionInput').value || '';
            const qs = new URLSearchParams({ lat, lon, ubi });
            window.location.href = `/Calendario/${encodeURIComponent(equipoId)}?${qs.toString()}`;
          });

          // Submit del form: evita recarga, valida tipo
          document.getElementById('frmBuscar')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const tipoId = (tipoSel.value || '').trim();
            const fi = document.getElementById('fechaInicio').value;
            const ff = document.getElementById('fechaFinal').value;

            if (!tipoId) {
              alert('Por favor selecciona un tipo de equipo.');
              tipoSel.focus();
              return;
            }

            // Validación de fechas
            if(fi && ff){
                const inicio = new Date(fi);
                const fin = new Date (ff);

                if(fin <= inicio){
                    alert('La fecha de fin debe ser mayor a la fecha de inicio.');
                    document.getElementById('fechaFinal').focus();
                    return;
                }
            }

            const params = new URLSearchParams({
              tipoId,
              fechaInicio: fi || '',
              fechaFin: ff || ''
            });

            const url = '@Url.Action("BuscarEquipos", "Reservas")' + '?' + params.toString();

            try {
              const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
              if (!r.ok) throw new Error('HTTP ' + r.status);
              const data = await r.json();

              if (data?.error) {
                alert(data.error);
                renderCards([]);
                return;
              }

              renderCards(data);
            } catch (err) {
              console.error(err);
              renderCards([]);
            }
          });
        })();
    </script>

}
